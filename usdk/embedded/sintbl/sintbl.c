#include "sintbl.h"

static RO u16 sintbl[] = {  // 0~90°, 256 等分
    0x0000, 0x00C9, 0x0192, 0x025B, 0x0324, 0x03ED, 0x04B6, 0x057F,
    0x0647, 0x0710, 0x07D9, 0x08A2, 0x096A, 0x0A33, 0x0AFB, 0x0BC3,
    0x0C8B, 0x0D53, 0x0E1B, 0x0EE3, 0x0FAB, 0x1072, 0x1139, 0x1201,
    0x12C8, 0x138E, 0x1455, 0x151B, 0x15E2, 0x16A8, 0x176D, 0x1833,
    0x18F8, 0x19BD, 0x1A82, 0x1B47, 0x1C0B, 0x1CCF, 0x1D93, 0x1E56,
    0x1F19, 0x1FDC, 0x209F, 0x2161, 0x2223, 0x22E5, 0x23A6, 0x2467,
    0x2528, 0x25E8, 0x26A8, 0x2767, 0x2826, 0x28E5, 0x29A3, 0x2A61,
    0x2B1F, 0x2BDC, 0x2C98, 0x2D55, 0x2E11, 0x2ECC, 0x2F87, 0x3041,
    0x30FB, 0x31B5, 0x326E, 0x3326, 0x33DE, 0x3496, 0x354D, 0x3604,
    0x36BA, 0x376F, 0x3824, 0x38D8, 0x398C, 0x3A40, 0x3AF2, 0x3BA5,
    0x3C56, 0x3D07, 0x3DB8, 0x3E68, 0x3F17, 0x3FC5, 0x4073, 0x4121,
    0x41CE, 0x427A, 0x4325, 0x43D0, 0x447A, 0x4524, 0x45CD, 0x4675,
    0x471C, 0x47C3, 0x4869, 0x490F, 0x49B4, 0x4A58, 0x4AFB, 0x4B9E,
    0x4C3F, 0x4CE0, 0x4D81, 0x4E21, 0x4EBF, 0x4F5E, 0x4FFB, 0x5097,
    0x5133, 0x51CE, 0x5269, 0x5302, 0x539B, 0x5433, 0x54CA, 0x5560,
    0x55F5, 0x568A, 0x571D, 0x57B0, 0x5842, 0x58D4, 0x5964, 0x59F3,
    0x5A82, 0x5B10, 0x5B9D, 0x5C29, 0x5CB4, 0x5D3E, 0x5DC7, 0x5E50,
    0x5ED7, 0x5F5E, 0x5FE3, 0x6068, 0x60EC, 0x616F, 0x61F0, 0x6271,
    0x62F2, 0x6371, 0x63EF, 0x646C, 0x64E8, 0x6563, 0x65DD, 0x6657,
    0x66CF, 0x6746, 0x67BD, 0x6832, 0x68A6, 0x6919, 0x698C, 0x69FD,
    0x6A6D, 0x6ADC, 0x6B4A, 0x6BB8, 0x6C24, 0x6C8F, 0x6CF9, 0x6D62,
    0x6DCA, 0x6E30, 0x6E96, 0x6EFB, 0x6F5F, 0x6FC1, 0x7023, 0x7083,
    0x70E2, 0x7141, 0x719E, 0x71FA, 0x7255, 0x72AF, 0x7307, 0x735F,
    0x73B5, 0x740B, 0x745F, 0x74B2, 0x7504, 0x7555, 0x75A5, 0x75F4,
    0x7641, 0x768E, 0x76D9, 0x7723, 0x776C, 0x77B4, 0x77FA, 0x7840,
    0x7884, 0x78C7, 0x7909, 0x794A, 0x798A, 0x79C8, 0x7A05, 0x7A42,
    0x7A7D, 0x7AB6, 0x7AEF, 0x7B26, 0x7B5D, 0x7B92, 0x7BC5, 0x7BF8,
    0x7C29, 0x7C5A, 0x7C89, 0x7CB7, 0x7CE3, 0x7D0F, 0x7D39, 0x7D62,
    0x7D8A, 0x7DB0, 0x7DD6, 0x7DFA, 0x7E1D, 0x7E3F, 0x7E5F, 0x7E7F,
    0x7E9D, 0x7EBA, 0x7ED5, 0x7EF0, 0x7F09, 0x7F21, 0x7F38, 0x7F4D,
    0x7F62, 0x7F75, 0x7F87, 0x7F97, 0x7FA7, 0x7FB5, 0x7FC2, 0x7FCE,
    0x7FD8, 0x7FE1, 0x7FE9, 0x7FF0, 0x7FF6, 0x7FFA, 0x7FFD, 0x7FFF};

/**
 * @param angle anhle in s16 format, range [S16_MIN,S16_MAX]
 */
void get_sin_cos(__IN s16 angle, __OUT f32* sin, __OUT f32* cos)
{
    /**
     *                index（记录角度在 0~90 中的位置索引）
     *                  |
     *           +------+--------+
     *           |               |
     *     (0b_0000_0000_0000_0000)     0,   16383 ->    0,  90
     *     (0b_0100_0000_0000_0000)  16384 , 32767 ->   90, 180
     *     (0b_1000_0000_0000_0000)  32768 , 49151 ->  180, 270
     *     (0b_1100_0000_0000_0000)  49152 , 65535 ->  270, 360
     *         ||
     *         ++
     *       sector（记录角度所在象限）
     *
     *    所用 SIN 表的分辨率是 256 (8bit) -> 索引位宽从高位开始取8位, 剩余的用于更高分辨率的低位丢掉
     *
     */

    u16 deg = angle + 32768;

    u8 sec = deg >> 14;
    u8 idx = deg >> 6;  // 分辨率: 2^8 = 256

    switch (sec) {
        case 0x00:  // 0~90
            *sin = +sintbl[idx];
            *cos = +sintbl[0xFF - idx];
            break;
        case 0x01:  // 90~180
            *sin = +sintbl[0xFF - idx];
            *cos = -sintbl[idx];
            break;
        case 0x02:  // 180~270
            *sin = -sintbl[idx];
            *cos = -sintbl[0xFF - idx];
            break;
        case 0x03:  // 270~360
            *sin = -sintbl[0xFF - idx];
            *cos = +sintbl[idx];
            break;
    }
    *sin /= 32768.f;
    *cos /= 32768.f;
}

#if 0  // DEBUG

#include <math.h>
#include <stdio.h>

int main()
{
#if 0
    // SIN 表生成
    u16   i = 0;
    FILE* f = fopen("sintbl.tmp.h", "w+");

    if (f) {
        fprintf(f, "static RO u8 sintbl[] = {\n");
        while (i < 256) {
            f32 angle = sinf(DEG2RAD * ((i / 256.f) * 90));
            fprintf(f, "0x%04X,", (u16)(angle * 32768));
            if (++i % 8 == 0) {
                fputc('\n', f);
            }
        }
        fprintf(f, "};");
        fclose(f);
    }
#else
    // SIN 表测试
    f32 s, c, v = MapTo(-200, 0, 360, S16_MIN, S16_MAX);
    get_sin_cos(v, &s, &c);
    println("%f,%f,%f", v, s, c);
#endif
    return 0;
}

#endif